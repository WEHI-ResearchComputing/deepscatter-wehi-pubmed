<style>
  .ttooltip {
    z-index: 99;
  }
  .legend-div {
    display: flex;
    align-items: center;
    margin: 2px;
    padding: 5px;
  }
  #color-legend {
    right: 0;
    flex-direction: column;
    align-items: right;
    justify-content: right;
    grid-template-columns: repeat(3, 1fr);
    display: grid;
  }
  .color-marker {
    width: 20px;
    height: 20px;
    margin-right: 5px;
    border: 1px solid #ccc;
  }
  .overlay {
    position: absolute;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.1);
    z-index: 99;
  }
</style>

<body>
  <h1>WEHI & Pubmed Landscape</h1>
  <div id="datestring"></div>
  <!-- <input id="date" title="date selector" type="range" min="-1800" max="1500" /> -->
  <div id="deepscatter">
    <div>
      <div id="left-overlay" class="overlay"></div>
      <div id="color-legend" class="overlay"></div>
    </div>
  </div>
</body>

<head>
  <style>
    dt {
      float: left;
      clear: left;
      width: 90px;
      font-weight: bold;
      color: rgb(128, 19, 0);
    }

    dt::after {
      content: ':';
    }

    dd {
      margin: 0 0 0 80px;
      padding: 0 0 0.5em 0;
      width: 180px;
    }
  </style>
</head>

<script type="module">
  import Scatterplot from './src/deepscatter';
  import { select } from 'd3-selection';
  window.select = select; // For the click function below.
  const prefs = {
    source_url: '/tiles',
    max_points: 750000, // a full cap.
    alpha: 100000, // Target saturation for the full page.
    zoom_balance: 0.35, // Rate at which points increase size. https://observablehq.com/@bmschmidt/zoom-strategies-for-huge-scatterplots-with-three-js
    //point_size: 10, // Default point size before application of size scaling
    point_size: 2,
    background_color: '#FFFFFF',
    zoom_align: 'right',
    click_function:
      "select('#ident').html(JSON.stringify(datum, undefined, 2))",
    background_options: {
      size: 1,
      mouseover: true,
      opacity: 0.01,
    },
    zoom: {
      bbox: {
        x: [-250, 250],
        y: [-250, 250]
      }
    },
    encoding: {
      /**
      Note--if you do not have a field called 'class' in your dataset, this will fail!
      */
      foreground: {
        field: 'labels',
        lambda: d => d !== 'unlabeled' // 
      },
      color: {
        field: 'labels',
        // range: 'category10',
        range: ["lightgrey", "#B79762", "#009271", "#004D43", "#5B4534", "#E83000", "#008941", "#549E79", "black", "#6F0062", "#006FA6", "#b65141", "#A4E804", "#8FB0FF", "#6B002C", "#3B5DFF", "#1CE6FF", "#FF9408", "#BA0900", "#1B4400", "#D790FF", "#0089A3", "#4FC601", "#00FECF", "#5A0007", "#00C2A0", "#FFB500", "#BC23FF", "#7A4900", "#CC0744", "#C20078", "#0000A6", "#aeaa00", "#FF2F80", "#FF34FF", "#FF4A46", "#FF90C9", "#6508ba", "#C895C5"],
        "domain": ["unlabeled", "microbiology", "neurology", "pediatric", "pharmacology", "physiology", "chemistry", "education", "cancer", "virology", "surgery", "biochemistry", "ophthalmology", "immunology", "rehabilitation", "veterinary", "cardiology", "pathology", "psychiatry", "genetics", "dermatology", "environment", "nutrition", "radiology", "psychology", "engineering", "gynecology", "physics", "infectious", "anesthesiology", "computation", "material", "neuroscience", "nursing", "ecology", "bioinformatics", "healthcare", "ethics", "optics"]
      },
      x: {
        field: 'x',
        transform: 'literal',
      },
      y: {
        field: 'y',
        transform: 'literal',
      },
      size: {
        field: 'WEHI-affiliated',
        range: [1, 0.1],
        domain: ['True', 'False'],
      },
      filter: {
      }
    },
  };

  const scatterplot = new Scatterplot('#deepscatter');
  const first_draw = scatterplot.plotAPI(prefs);
  window.plot = scatterplot; // For debugging
  let cycle = 0;
  const width = 600;
  function redo_scale() {
    const scale = scatterplot._renderer.aes.store.color.current.scale;
    const domain = scale.domain();
    const range = scale.range();
    select('#color-legend')
      .selectAll('div')
      .data(domain)
      .join('div')
      .attr('class', 'legend-div')
      .html((d) => `
        <span class="color-marker" style="background-color: ${scale(d)}"></span>
        ${d}
      `);
  }
  first_draw.then(() => {
    const holder = select('#left-overlay');
    const buttons = holder
      .selectAll('button')
      .data([
        'WEHI with All',
        'All'
      ]);
    redo_scale();
    buttons
      .enter()
      .append('div')
      .style('display', 'flex')
      .style('flex', 'row')
      .append('button')
      .text((d) => d)
      .on('click', function (d) {
        const button = select(this);
        const field = button.text();
        if (field === "WEHI with All") {
            scatterplot
              .plotAPI({
                alpha: 100000,
                max_points: 10000000,
                point_size: 5,
                encoding: {
                  background_options: {
                    size: 0.1,
                  },
                  filter: {
                    field: 'WEHI-affiliated',
                    lambda: d => d === 'True'
                  }
                },
              })
        } else if (field === "All") {
            scatterplot.plotAPI(prefs)
        }
      });
  });
</script>